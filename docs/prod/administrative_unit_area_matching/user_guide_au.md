# User guide for the production of the AU (Administrative units) theme

## Step 1: model conversion
When a new AU dataset is received for a country, the first step consists in implementing the model conversion parameter file, then launch the model conversion itself.
See [add link]
As a result, the administrative tables for each relevant level for the country will be filled:
* au.administrative_unit_area_1
* au.administrative_unit_area_2
* au.administrative_unit_area_3
* au.administrative_unit_area_4
* au.administrative_unit_area_5
* au.administrative_unit_area_6

## Step 2: generate OME2 international boundaries with neighbouring countries


## Step 3: edge-match administrative units at the lowest level

| country                        | country_code | distance | highest_level | 
|--------------------------------|--------------|----------|---------------|
| The Netherlands                | nl           | 1000     | 3             |
| Belgium                        | be           | 1000     | 5             |
| France                         | fr           | 1000     | 6             |
| Suisse                         | ch           | 1000     |               |
| Luxembourg                     | lu           | 1000     |               |


#### 1) Extract objects around a country's boundaries for matching:
Ensure that the distance of extraction and the lowest administrative level of the country to process are specified in the data-tools configuration file :
```
        ...
        "au_matching": {
            "table_name_prefix": "administrative_unit_area_",
            "extraction_distance": {
                "default": 1000
            },
            "lowest_level": {
                "be": 5,
                "es": 4,
                "fr": 6
            }
        },
        ...
```

Launch the extraction process:
```
python3 script/prepare_au_matching.py -c path/to/conf.json -b <neighbor1> -b <neighbor2> -s <working_table_suffix> <country_code>

```
The data are extracted in a working table named:
```
administrative_unit_area_<lowest_level>_w_<country>_<suffix>
```

<u>Belgium:</u>
Example of an extraction around boundaries with several neighbouring countries:
```
python3 script/prepare_au_matching.py -c path/to/conf.json -b nl -b de -b lu -s 20251014 be
```

Example of an extraction around all boundaries:
```
python3 script/prepare_au_matching.py -c path/to/conf.json -s 20251014 be
```

### 2) Matching

Enter the working table name in the au_matching configuration file theme_parameters:
```
AREA_TABLE_INIT                     =administrative_unit_area_<lowest_level>_w_<country>_<suffix>
```

In this configuration file add if it doesn't exist a section for the country to process:
```
[<country>]
COUNTRY_CODE_W                      =<country>
```

Launch the matching process:
```
bin/au_matching --c data/config/epg_parameters.ini --t <working_schema>.administrative_unit_area_<highest_level>_w --cc <country_code>
```

When the process in completed check in the log file path/to/log/dir/<last_step_number>_AuMatching.log if there are occurences of the log error :
```
Path not found for object [id] : <object_id>
```

For each of those errors mesure the maximum deviation between the administrative unit (whose identifier is <object_id>) and the international boundary.
Then overload the parameter AU_BOUNDARY_SEARCH_DIST with the highest deviation value by adding it in the country section:
```
[<country>]
COUNTRY_CODE_W                      =<country>
AU_BOUNDARY_SEARCH_DIST             =<highest_deviation>
```

Launch the last step of the matching process:
```
bin/au_matching --c path/to/epg_parameters.ini --cc <country_code> --sp <last_step_number>
```

Check in the log file that no more "Path not found" errors appear.

### 3) Integrate modifications in the main table and working history (wh) table
Before running the integrate, check in the log file whether invalid polygons have been generated by the matching process. If there are some, correct them in QGIS.

```
python3 script/integrate.py -c conf.json -T au -t administrative_unit_area_<highest_level> -s 30
```

## Step 4: edge-match administrative units at all other levels
Upper level administrative units are recreated by merging AUs at a lower level, using the [au_merging](https://github.com/openmapsforeurope2/au_merging) tool on each level successively. 

Please note that the last complete level should be used as reference for merging. For instance, in France, level 5 does not cover the whole territory. Therefore, au.administrative_unit_area_4 will be recreated using au.administrative_unit_area_6 as reference:
<pre>ome2_au_merging --c path/to/config/epg_parameters_merging_ng.ini --s au_administrative_unit_area_6 --t administrative_unit_area_4_w --cc fr</pre>

### 1) Extract objects around a country's boundaries
```
python3 script/border_extract.py -c conf.json -T au -t administrative_unit_area_<n> -d <distance> <country_code> '#'
```

### 2) Merging
```
bin/au_merging --c data/config/epg_parameters.ini --s <administrative_schema>.administrative_unit_area_<n+1> --t <working_schema>.administrative_unit_area_<n>_w --cc <country_code>
```

### 3)  Integrate modifications in the main table and working history (wh) table
Before running the integrate, check in the log file whether invalid polygons have been generated by the matching process. If there are some, correct them in QGIS.
```
python3 script/integrate.py -c conf.json -T au -t administrative_unit_area_<n> -s 30
```
